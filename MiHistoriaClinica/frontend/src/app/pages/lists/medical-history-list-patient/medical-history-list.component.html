<div class="container content-with-toolbar">

    <!-- üîµ T√≠tulo principal -->
    <div class="page-title">
        <h1>Mi Historia Cl√≠nica</h1>
    </div>

    <!-- üîµ Filtros y bot√≥n abajo del t√≠tulo -->
    <form [formGroup]="downloadList">
        <div class="filters-section">
            <h4>Seleccione secciones para visualizar/descargar:</h4>
            <div class="filters-row">
                <mat-checkbox formControlName="fichaMedica">Ficha m√©dica</mat-checkbox>
                <mat-checkbox formControlName="medicamentos">Medicamentos</mat-checkbox>
                <mat-checkbox formControlName="estudios">Estudios</mat-checkbox>
                <mat-checkbox formControlName="consultasMedicas">Consultas m√©dicas</mat-checkbox>
            </div>
            
            <div class="button-container">
                <button class="boton" (click)="downloadMedicalHistory()">Descargar PDF</button>
            </div>
        </div>
    </form>

    <!-- üîµ Ficha M√©dica -->
    <div *ngIf="showMedicalFile" class="medical-file-section">
        <h2 class="text-center">Ficha M√©dica</h2>
        <div class="medical-file-content" *ngIf="medicalHistory">
            <div class="medical-file-item">
                <span class="medical-file-label">Altura:</span>
                <span class="medical-file-value">{{ medicalHistory.height }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Peso:</span>
                <span class="medical-file-value">{{ medicalHistory.weight }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Grupo sangu√≠neo:</span>
                <span class="medical-file-value">{{ medicalHistory.bloodType }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Alergias:</span>
                <span class="medical-file-value">{{ medicalHistory.allergy }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Medicaci√≥n cr√≥nica:</span>
                <span class="medical-file-value">{{ medicalHistory.actualMedicine }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Enfermedades cr√≥nicas:</span>
                <span class="medical-file-value">{{ medicalHistory.chronicDisease }}</span>
            </div>
            <div class="medical-file-item">
                <span class="medical-file-label">Antecedentes familiares:</span>
                <span class="medical-file-value">{{ medicalHistory.familyMedicalHistory }}</span>
            </div>
        </div>
    </div>

    <!-- üîµ Medicamentos -->
    <div *ngIf="showMedicines" class="medicines-section">
        <h2 class="text-center">Medicamentos</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Medicaci√≥n</th>
                    <th>Descripci√≥n</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let medicine of medicines">
                    <td>{{ medicine.name }}</td>
                    <td>
                        <div style="max-width: 300px; position: relative;" class="expandable-text" (mouseenter)="showTooltip($event, medicine.description)" (mouseleave)="hideTooltip()">
                            <span>{{ medicine.description?.length > 80 ? (medicine.description | slice:0:80) + '...' : medicine.description }}</span>
                        </div>
                    </td>
                    <td>{{ medicine.status }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- üîµ Estudios -->
    <div *ngIf="showAnalysis" class="analysis-section">
        <h2 class="text-center">Estudios</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Estudio</th>
                    <th>Descripci√≥n</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let analysis of analysisList">
                    <td>{{ formatAnalysisName(analysis.name) }}</td>
                    <td>
                        <div style="max-width: 300px; position: relative;" class="expandable-text" (mouseenter)="showTooltip($event, analysis.description)" (mouseleave)="hideTooltip()">
                            <span>{{ analysis.description?.length > 80 ? (analysis.description | slice:0:80) + '...' : analysis.description }}</span>
                        </div>
                    </td>
                    <td>{{ analysis.status }}</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- üîµ Consultas M√©dicas -->
    <div *ngIf="showAppointments" class="appointments-section">
        <h2 class="text-center">Consultas</h2>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead class="table-dark">
                <tr>
                    <th>Nombre del m√©dico</th>
                    <th>Especialidad</th>
                    <th>Motivo de consulta</th>
                    <th>S√≠ntomas</th>
                    <th>Examen f√≠sico</th>
                    <th>Observaciones</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let appointment of appointments">
                    <td>{{ appointment.medicFullName }}</td>
                    <td>{{ appointment.specialty }}</td>
                    <td>{{ appointment.appointmentReason }}</td>
                    <td>
                        <div style="max-width: 200px; position: relative;">
                            <span>{{ appointment.currentIllness?.length > 60 ? (appointment.currentIllness | slice:0:60) + '...' : appointment.currentIllness }}</span>
                            <button *ngIf="appointment.currentIllness?.length > 60" 
                                    class="btn btn-sm btn-link" 
                                    (click)="showFullText('S√≠ntomas', appointment.currentIllness)"
                                    style="padding: 0; margin-left: 5px; font-size: 0.85em; vertical-align: baseline;">
                                Ver m√°s
                            </button>
                        </div>
                    </td>
                    <td>
                        <div style="max-width: 200px; position: relative;">
                            <span>{{ appointment.physicalExam?.length > 60 ? (appointment.physicalExam | slice:0:60) + '...' : appointment.physicalExam }}</span>
                            <button *ngIf="appointment.physicalExam?.length > 60" 
                                    class="btn btn-sm btn-link" 
                                    (click)="showFullText('Examen F√≠sico', appointment.physicalExam)"
                                    style="padding: 0; margin-left: 5px; font-size: 0.85em; vertical-align: baseline;">
                                Ver m√°s
                            </button>
                        </div>
                    </td>
                    <td>
                        <div style="max-width: 200px; position: relative;" class="expandable-text" (mouseenter)="showTooltip($event, appointment.observations)" (mouseleave)="hideTooltip()">
                            <span>{{ appointment.observations?.length > 60 ? (appointment.observations | slice:0:60) + '...' : appointment.observations }}</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Tooltip flotante global -->
<div *ngIf="tooltipText" 
     class="global-tooltip" 
     [style.left.px]="tooltipX" 
     [style.top.px]="tooltipY">
    {{ tooltipText }}
</div>
