<div class="container content-with-toolbar">
  <!-- Título principal -->
  <div class="page-title">
    <h1>Calendario</h1>
  </div>

  <!-- Referencia de colores y botón -->
  <div class="calendar-controls">
    <div class="legend-section">
      <h4>Referencia:</h4>
      <div class="legend-row">
        <div class="legend-item filter-option" 
             [class.active]="calendarFilter === 'all'"
             (click)="setCalendarFilter('all')"
             style="cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.3s;"
             [style.background]="calendarFilter === 'all' ? 'rgba(59, 130, 246, 0.1)' : 'transparent'"
             [style.border]="calendarFilter === 'all' ? '2px solid #3b82f6' : '2px solid transparent'">
          <span class="legend-color" style="background: linear-gradient(to right, #9e9e9e 50%, #3fb5eb 50%);"></span>
          <span>Vista completa</span>
        </div>
        <div class="legend-item filter-option" 
             [class.active]="calendarFilter === 'available'"
             (click)="setCalendarFilter('available')"
             style="cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.3s;"
             [style.background]="calendarFilter === 'available' ? 'rgba(158, 158, 158, 0.2)' : 'transparent'"
             [style.border]="calendarFilter === 'available' ? '2px solid #9e9e9e' : '2px solid transparent'">
          <span class="legend-color" style="background:#9e9e9e;"></span>
          <span>Disponibles</span>
        </div>
        <div class="legend-item filter-option" 
             [class.active]="calendarFilter === 'reserved'"
             (click)="setCalendarFilter('reserved')"
             style="cursor: pointer; padding: 8px 12px; border-radius: 4px; transition: all 0.3s;"
             [style.background]="calendarFilter === 'reserved' ? 'rgba(63, 181, 235, 0.2)' : 'transparent'"
             [style.border]="calendarFilter === 'reserved' ? '2px solid #3fb5eb' : '2px solid transparent'">
          <span class="legend-color" style="background:#3fb5eb;"></span>
          <span>Reservados</span>
        </div>
      </div>
    </div>
    <div class="button-container">
      <button class="boton" (click)="showModal = true">Agregar turnos disponibles</button>
    </div>
  </div>

  <!-- Calendario -->
  <div class="calendar-section">
    <div class="full-calendar-wrapper">
      <full-calendar #calendar [options]="calendarOptions"></full-calendar>
    </div>
  </div>
</div>

<!-- Modal para agregar turnos disponibles -->
<div class="modal-backdrop show" *ngIf="showModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showModal">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar turnos disponibles</h5>
        <button type="button" class="close" aria-label="Close" (click)="showModal = false" style="font-size:2rem;line-height:1;color:#000;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="addAvailableSlots()" class="row g-3">
          <div class="col-12 col-md-6">
            <label>Días de atención:</label>
            <div *ngFor="let day of daysOfWeek">
              <input type="checkbox"
                     [checked]="availableDays.includes(day.value)"
                     (change)="onDayCheckboxChange($event, day.value)" /> {{day.name}}
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label>Hora inicio:</label>
            <input type="time" class="form-control mb-2" [(ngModel)]="startTime" name="startTime" required>
            <label>Hora fin:</label>
            <input type="time" class="form-control mb-2" [(ngModel)]="endTime" name="endTime" required>
            <label>Duración (min):</label>
            <select class="form-control mb-2" [(ngModel)]="slotDuration" name="slotDuration" required>
              <option value="" disabled selected>Seleccione duración</option>
              <option *ngFor="let d of durationOptions" [value]="d">{{ d }} minutos</option>
            </select>
            <label>Centro médico:</label>
            <select class="form-control mb-2" [(ngModel)]="medicalCenter" name="medicalCenter" required>
              <option value="" disabled selected>Seleccione un centro médico</option>
              <option *ngFor="let option of medicalCenterOptions" [value]="option">{{ option }}</option>
            </select>
          </div>
          <div class="col-12 d-flex justify-content-center gap-3 mt-3">
            <button type="submit" class="boton" [disabled]="!startTime || !endTime || !medicalCenter || availableDays.length === 0">Aceptar</button>
            <button type="button" class="boton-secondary" (click)="showModal = false">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para vista detallada de turnos -->
<div class="modal-backdrop show" *ngIf="showDetailModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showDetailModal">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Turnos para {{ getFormattedDate(selectedDate) }}</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeDetailModal()" style="font-size:2rem;line-height:1;color:#000;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <!-- Filtros de vista -->
        <div class="row mb-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Filtrar por estado:</label>
            <select class="form-select" [(ngModel)]="viewType">
              <option value="all">Todos los turnos</option>
              <option value="available">Solo disponibles</option>
              <option value="reserved">Solo reservados</option>
            </select>
          </div>
        </div>

        <!-- Lista de turnos -->
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-dark" style="position: sticky; top: 0; z-index: 10;">
              <tr>
                <th>Hora</th>
                <th>Centro Médico</th>
                <th>Estado</th>
                <th>Paciente</th>
                <th style="width: 280px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let turno of getFilteredTurnos()" 
                  [style.background-color]="getRowBackgroundColor(turno)">
                <td>{{ formatTime(turno.horaTurno) }}</td>
                <td>{{ formatMedicalCenter(turno.medicalCenter) }}</td>
                <td>
                  <span class="badge" 
                        [style.background-color]="getBadgeColor(turno)" 
                        [style.color]="'#fff'">
                    {{ getBadgeText(turno) }}
                  </span>
                </td>
                <td>
                  <span *ngIf="turno.patientName">
                    {{ turno.patientName }} {{ turno.patientLastname }}
                  </span>
                  <span *ngIf="!turno.patientName" class="text-muted">-</span>
                </td>
                <td>
                  <!-- Acciones para turno DISPONIBLE -->
                  <div *ngIf="turno.available" style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" (click)="abrirReservarTurno(turno)" title="Reservar para paciente" style="background-color: #3fb5eb; border-color: #3fb5eb; color: white;">
                      <i class="fas fa-user-plus"></i> Reservar
                    </button>
                    <button class="btn btn-sm btn-secondary" (click)="abrirModalBloquear(turno)" title="Bloquear turno" style="background-color: #495057; border-color: #495057;">
                      <i class="fas fa-ban"></i> Bloquear
                    </button>
                  </div>
                  
                  <!-- Acciones para turno RESERVADO o BLOQUEADO -->
                  <div *ngIf="!turno.available">
                    <button class="btn btn-sm" 
                            (click)="liberarTurnoIndividual(turno)" 
                            [title]="turno.patientName ? 'Cancelar turno' : 'Desbloquear'"
                            [style.background-color]="turno.patientName ? 'transparent' : '#495057'"
                            [style.border]="turno.patientName ? '2px solid #6c757d' : '1px solid #495057'"
                            [style.color]="turno.patientName ? '#6c757d' : 'white'">
                      <i class="fas fa-unlock"></i> {{ turno.patientName ? 'Cancelar turno' : 'Desbloquear' }}
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mensaje cuando no hay turnos -->
        <div class="alert alert-info text-center" *ngIf="getFilteredTurnos().length === 0">
          <i class="fas fa-info-circle"></i> No hay turnos que mostrar con el filtro seleccionado.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="boton-secondary" (click)="closeDetailModal()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para bloquear turno -->
<div class="modal-backdrop show" *ngIf="showBlockModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showBlockModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #495057; color: white;">
        <h5 class="modal-title">Bloquear Turno</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeBlockModal()" style="font-size:2rem;line-height:1;color:#fff;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" *ngIf="turnoToBlock">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>¿Está seguro que desea bloquear este turno?</strong>
        </div>
        <div class="alert alert-info" *ngIf="turnoToBlock">
          <strong>Turno:</strong> {{ formatTime(turnoToBlock.horaTurno) }}<br>
          <strong>Centro:</strong> {{ formatMedicalCenter(turnoToBlock.medicalCenter) }}
        </div>
        <p>El turno quedará marcado como no disponible y no podrá ser reservado por pacientes.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeBlockModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn" style="background-color: #495057; color: white; border-color: #495057;" (click)="confirmarBloqueoTurno()">
          <i class="fas fa-ban"></i> Confirmar Bloqueo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de error/notificación -->
<div class="modal-backdrop show" *ngIf="showErrorModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showErrorModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" [style.background-color]="errorTitle.includes('✅') ? '#3fb5eb' : '#dc3545'" style="color: white;">
        <h5 class="modal-title">
          <i [class]="errorTitle.includes('✅') ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
          {{ errorTitle }}
        </h5>
        <button type="button" class="close" aria-label="Close" (click)="closeErrorModal()" style="font-size:2rem;line-height:1;color:#fff;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div [class]="errorTitle.includes('✅') ? 'alert alert-success' : 'alert alert-danger'">
          <p style="margin: 0;">{{ errorMessage }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" 
                [style.background-color]="errorTitle.includes('✅') ? '#3fb5eb' : '#6c757d'" 
                style="color: white;"
                (click)="closeErrorModal()">
          <i class="fas fa-check"></i> Entendido
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación para cancelar reserva -->
<div class="modal-backdrop show" *ngIf="showCancelModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showCancelModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #6c757d; color: white;">
        <h5 class="modal-title">{{ turnoToCancel?.patientName ? 'Cancelar turno' : 'Desbloquear Turno' }}</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeCancelModal()" style="font-size:2rem;line-height:1;color:#fff;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" *ngIf="turnoToCancel">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>{{ turnoToCancel.patientName ? '¿Cancelar reserva del turno de las ' : '¿Desbloquear turno de las ' }}{{ formatTime(turnoToCancel.horaTurno) }}{{ turnoToCancel.patientName ? ' de ' + turnoToCancel.patientName + ' ' + turnoToCancel.patientLastname : '' }}?</strong>
        </div>
        <p>{{ turnoToCancel?.patientName ? 'El turno volverá a estar disponible.' : 'El turno volverá a estar disponible.' }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCancelModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn" 
                style="background-color: #6c757d; color: white; border-color: #6c757d;" 
                (click)="confirmarLiberarTurno()">
          <i class="fas fa-check"></i> Confirmar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para reservar turno individual -->
<div class="modal-backdrop show" *ngIf="showReserveModal"></div>
<div class="modal show d-block" tabindex="-1" *ngIf="showReserveModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #3fb5eb; color: white;">
        <h5 class="modal-title">Reservar Turno</h5>
        <button type="button" class="close" aria-label="Close" (click)="closeReserveModal()" style="font-size:2rem;line-height:1;color:#fff;background:transparent;border:none;outline:none;">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" *ngIf="turnoToReserve">
          <strong>Turno:</strong> {{ formatTime(turnoToReserve.horaTurno) }}<br>
          <strong>Centro:</strong> {{ formatMedicalCenter(turnoToReserve.medicalCenter) }}
        </div>

        <div class="form-group">
          <label>Seleccionar paciente:</label>
          <select class="form-control" 
                  [(ngModel)]="selectedPatientDni" 
                  name="patientSelect">
            <option value="">-- Seleccionar paciente --</option>
            <option *ngFor="let patient of myPatients" [value]="patient.dni">
              {{ patient.name }} {{ patient.lastname }} - DNI: {{ patient.dni }}
            </option>
          </select>
        </div>

        <div class="alert alert-warning mt-3" *ngIf="myPatients.length === 0">
          <i class="fas fa-info-circle"></i> No tienes pacientes asociados. 
          <a href="/medic/link-patient" class="alert-link">Vincular pacientes aquí</a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeReserveModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn" 
                (click)="confirmarReservaTurno()" 
                [disabled]="!isPacienteSeleccionado()"
                [style.background-color]="isPacienteSeleccionado() ? '#3fb5eb' : '#cccccc'"
                [style.border-color]="isPacienteSeleccionado() ? '#3fb5eb' : '#cccccc'"
                style="color: white;">
          <i class="fas fa-check"></i> Confirmar Reserva
        </button>
      </div>
    </div>
  </div>
</div>
